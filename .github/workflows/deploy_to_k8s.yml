# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
# Environment variables available to all jobs and steps in this workflow
env:
  CLUSTER_NAME: afn_cluster
  NAMESPACE: default

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    
      - name: Kubernetes Set Context
        uses: Azure/k8s-set-context@v2
        with:
          # Acceptable values: generic or arc
          cluster-type: generic
          # Acceptable values: kubeconfig or service-account or service-principal
          method: kubeconfig
          # Contents of kubeconfig file
          kubeconfig: ${{secrets.KUBE_CONFIG}}
      
      - name: Kubernetes Create Secrets
        uses: azure/k8s-create-secret@v2
        with:
          namespace: ${{ env.NAMESPACE }}
          secret-type: 'generic'
          secret-name: afnsecrets
          string-data: ${{ secrets.AFN_SECRETS_STRING_DATA}}
          
      # Deploy app to AKS
      - uses: azure/k8s-deploy@v3.1
        with:
          manifests: |
            ./k8/
          images: |
            ghcr.io/tooflex/african-names-server/frontend:${{ github.sha }}
            ghcr.io/tooflex/african-names-server/backend:${{ github.sha }}
          imagepullsecrets: |
            afnsecrets
          namespace: ${{ env.NAMESPACE }}
